!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealTimeStats=e():t.RealTimeStats=e()}(self,(()=>(()=>{var t={187:t=>{"use strict";var e,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(t,e,i){return Function.prototype.apply.call(t,e,i)};e=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var r=Number.isNaN||function(t){return t!=t};function n(){n.init.call(this)}t.exports=n,t.exports.once=function(t,e){return new Promise((function(i,s){function r(i){t.removeListener(e,n),s(i)}function n(){"function"==typeof t.removeListener&&t.removeListener("error",r),i([].slice.call(arguments))}v(t,e,n,{once:!0}),"error"!==e&&function(t,e,i){"function"==typeof t.on&&v(t,"error",e,i)}(t,r,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?n.defaultMaxListeners:t._maxListeners}function l(t,e,i,s){var r,n,o,l;if(a(i),void 0===(n=t._events)?(n=t._events=Object.create(null),t._eventsCount=0):(void 0!==n.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),n=t._events),o=n[e]),void 0===o)o=n[e]=i,++t._eventsCount;else if("function"==typeof o?o=n[e]=s?[i,o]:[o,i]:s?o.unshift(i):o.push(i),(r=c(t))>0&&o.length>r&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=o.length,l=u,console&&console.warn&&console.warn(l)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(t,e,i){var s={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},r=u.bind(s);return r.listener=i,s.wrapFn=r,r}function p(t,e,i){var s=t._events;if(void 0===s)return[];var r=s[e];return void 0===r?[]:"function"==typeof r?i?[r.listener||r]:[r]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(r):d(r,r.length)}function f(t){var e=this._events;if(void 0!==e){var i=e[t];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function d(t,e){for(var i=new Array(e),s=0;s<e;++s)i[s]=t[s];return i}function v(t,e,i,s){if("function"==typeof t.on)s.once?t.once(e,i):t.on(e,i);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function r(n){s.once&&t.removeEventListener(e,r),i(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var r="error"===t,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=n[t];if(void 0===c)return!1;if("function"==typeof c)s(c,this,e);else{var l=c.length,u=d(c,l);for(i=0;i<l;++i)s(u[i],this,e)}return!0},n.prototype.addListener=function(t,e){return l(this,t,e,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(t,e){return l(this,t,e,!0)},n.prototype.once=function(t,e){return a(e),this.on(t,h(this,t,e)),this},n.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,h(this,t,e)),this},n.prototype.removeListener=function(t,e){var i,s,r,n,o;if(a(e),void 0===(s=this._events))return this;if(void 0===(i=s[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete s[t],s.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(r=-1,n=i.length-1;n>=0;n--)if(i[n]===e||i[n].listener===e){o=i[n].listener,r=n;break}if(r<0)return this;0===r?i.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(i,r),1===i.length&&(s[t]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",t,o||e)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(t){var e,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[t]),this;if(0===arguments.length){var r,n=Object.keys(i);for(s=0;s<n.length;++s)"removeListener"!==(r=n[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(void 0!==e)for(s=e.length-1;s>=0;s--)this.removeListener(t,e[s]);return this},n.prototype.listeners=function(t){return p(this,t,!0)},n.prototype.rawListeners=function(t){return p(this,t,!1)},n.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}},43:function(t,e,i){var s,r;!function(n,o){"use strict";s=function(){var t=function(){},e="undefined",i=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"];function r(t,e){var i=t[e];if("function"==typeof i.bind)return i.bind(t);try{return Function.prototype.bind.call(i,t)}catch(e){return function(){return Function.prototype.apply.apply(i,[t,arguments])}}}function n(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function o(s){return"debug"===s&&(s="log"),typeof console!==e&&("trace"===s&&i?n:void 0!==console[s]?r(console,s):void 0!==console.log?r(console,"log"):t)}function a(e,i){for(var r=0;r<s.length;r++){var n=s[r];this[n]=r<e?t:this.methodFactory(n,e,i)}this.log=this.debug}function c(t,i,s){return function(){typeof console!==e&&(a.call(this,i,s),this[t].apply(this,arguments))}}function l(t,e,i){return o(t)||c.apply(this,arguments)}function u(t,i,r){var n,o=this;i=null==i?"WARN":i;var c="loglevel";function u(t){var i=(s[t]||"silent").toUpperCase();if(typeof window!==e&&c){try{return void(window.localStorage[c]=i)}catch(t){}try{window.document.cookie=encodeURIComponent(c)+"="+i+";"}catch(t){}}}function h(){var t;if(typeof window!==e&&c){try{t=window.localStorage[c]}catch(t){}if(typeof t===e)try{var i=window.document.cookie,s=i.indexOf(encodeURIComponent(c)+"=");-1!==s&&(t=/^([^;]+)/.exec(i.slice(s))[1])}catch(t){}return void 0===o.levels[t]&&(t=void 0),t}}function p(){if(typeof window!==e&&c){try{return void window.localStorage.removeItem(c)}catch(t){}try{window.document.cookie=encodeURIComponent(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(t){}}}"string"==typeof t?c+=":"+t:"symbol"==typeof t&&(c=void 0),o.name=t,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=r||l,o.getLevel=function(){return n},o.setLevel=function(i,s){if("string"==typeof i&&void 0!==o.levels[i.toUpperCase()]&&(i=o.levels[i.toUpperCase()]),!("number"==typeof i&&i>=0&&i<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+i;if(n=i,!1!==s&&u(i),a.call(o,i,t),typeof console===e&&i<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(t){i=t,h()||o.setLevel(t,!1)},o.resetLevel=function(){o.setLevel(i,!1),p()},o.enableAll=function(t){o.setLevel(o.levels.TRACE,t)},o.disableAll=function(t){o.setLevel(o.levels.SILENT,t)};var f=h();null==f&&(f=i),o.setLevel(f,!1)}var h=new u,p={};h.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=p[t];return e||(e=p[t]=new u(t,h.getLevel(),h.methodFactory)),e};var f=typeof window!==e?window.log:void 0;return h.noConflict=function(){return typeof window!==e&&window.log===h&&(window.log=f),h},h.getLoggers=function(){return p},h.default=h,h},void 0===(r="function"==typeof s?s.call(e,i,e,t):s)||(t.exports=r)}()},239:(t,e,i)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VideoNetworkQualityStats=void 0;const s=i(43),r=i(436),n=i(187);var o;!function(t){t[t.PAUSED=0]="PAUSED",t[t.EFFECT_APPLIED=1]="EFFECT_APPLIED",t[t.INPUT_FORWARDING=2]="INPUT_FORWARDING"}(o||(o={}));class a extends n.EventEmitter{constructor(t){super(),this.prevPacketsLost={},this.prevTimeStamp={},this.simulcastLayers=[],this.prevPacketsSent={},this._publisher=null,this._statsInterval=t.intervalStats,this._VideoPacketLossThreshold=t.VideoPacketLossThreshold,this._interval=null,this.isQualityLimitated=!1,this.wasQualityLimited=!1,this.hasPacketLoss=!1,this.hadPacketLoss=!1,this.prevPacketsSent={},this.prevPacketsLost={},this.packetLossArray=[],this.layersWithPacketLoss=[]}setPublisher(t){this._publisher=t}checkIfQualityLimited(t){t[0].rtcStatsReport.forEach((t=>{if("outbound-rtp"===t.type&&"video"===t.kind){if(this.prevTimeStamp[t.ssrc]&&this.prevPacketsSent[t.ssrc]){const e=t.timestamp-this.prevTimeStamp[t.ssrc],i=8*(t.bytesSent-this.prevPacketsSent[t.ssrc])/e,s={width:t.frameWidth,height:t.frameHeight,framesPerSecond:t.framesPerSecond,qualityLimitationReason:t.qualityLimitationReason,id:t.ssrc,bytes:i,packetsDiff:t.packetsSent-this.prevPacketsSent[t.ssrc]};this.simulcastLayers=[...this.simulcastLayers,s],this.simulcastLayers.forEach((t=>{"none"===t.qualityLimitationReason||!1!==this.isQualityLimitated||this.wasQualityLimited?this.wasQualityLimited&&"none"===t.qualityLimitationReason&&this.isQualityLimitated&&(this.isQualityLimitated=!1,this.emit("qualityLimitatedStopped",{streamId:this._publisher.stream.id,reason:t.qualityLimitationReason,targetQuality:`${t.width}X${t.height}`})):(this.isQualityLimitated=!0,this.emit("qualityLimitated",{streamId:this._publisher.stream.id,reason:t.qualityLimitationReason,id:t.id,targetQuality:`${t.width}X${t.height}`}))}))}this.prevPacketsSent[t.ssrc]=t.packetsSent,this.prevTimeStamp[t.ssrc]=t.timestamp,this.wasQualityLimited=this.isQualityLimitated}}))}checkVideoPacketLoss(t){t[0].rtcStatsReport.forEach((t=>{if("remote-inbound-rtp"===t.type&&"video"===t.kind){const e={ssrc:t.ssrc,rtt:t.roundTripTime,jitter:t.jitter,packetLostFraction:100*t.fractionLost,packetsLostDiff:t.packetsLost-this.prevPacketsLost[t.ssrc]};this.packetLossArray=[...this.packetLossArray,e],this.prevPacketsLost[t.ssrc]=t.packetsLost,this.mergeArrays()}}))}mergeArrays(){if(this.packetLossArray&&this.simulcastLayers.length){this.layersWithPacketLoss=[];for(let t of this.simulcastLayers)for(let e of this.packetLossArray)if(t.id===e.ssrc&&t.framesPerSecond){const i=t.packetsDiff+e.packetsLostDiff,s=e.packetsLostDiff/i,r=Object.assign({rtt:e.rtt,jitter:e.jitter,packetLost:100*s},t);this.layersWithPacketLoss=[...this.layersWithPacketLoss,r];const n=Math.max.apply(Math,this.layersWithPacketLoss.map((function(t){return t.id}))),o=this.layersWithPacketLoss.find((function(t){return t.id==n}));o.packetLost>=this._VideoPacketLossThreshold&&!this.hadPacketLoss&&!this.hasPacketLoss?(this.hasPacketLoss=!0,this.emit("highPacketLoss",{streamId:this._publisher.stream.id,type:"video",action:"highPacketLossDetected",packetLossThreshold:this._VideoPacketLossThreshold})):this.hadPacketLoss&&this.hasPacketLoss&&o.packetLost<this._VideoPacketLossThreshold&&(this.hasPacketLoss=!1,this.emit("highPacketLossStopped",{streamId:this._publisher.stream.id,type:"video",action:"highPacketLossStopped",packetLossThreshold:this._VideoPacketLossThreshold}))}this.hadPacketLoss=this.hasPacketLoss}}startStats(){setInterval((async()=>{this.simulcastLayers=[],this.packetLossArray=[];const t=await(0,r.getRtcStats)(this._publisher);return this.checkIfQualityLimited(t),this.checkVideoPacketLoss(t),t}),this._statsInterval)}stopStats(){clearInterval(this._interval),this._interval=null}async getCypher(){return new Promise((async(t,e)=>{(await(0,r.getRtcStats)(this._publisher))[0].rtcStatsReport.forEach((e=>{"transport"===e.type&&t(e.srtpCipher)}))}))}async getConnectionType(){return new Promise((async(t,e)=>{(await(0,r.getRtcStats)(this._publisher))[0].rtcStatsReport.forEach((e=>{"local-candidate"===e.type&&("relay"===e.candidateType?t(`TURN ${e.relayProtocol}`):t(e.protocol))}))}))}pauseStreamProcessing(t){console.log("ss")}setOutputState(t){}destroy(){s.default.debug("destroy")}}e.VideoNetworkQualityStats=a},436:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getSrtpCipher=e.getRtcStats=e.logPublisher=void 0,e.logPublisher=function(t){console.log(t)},e.getRtcStats=async function(t){return new Promise((async(e,i)=>{try{e(await t.getRtcStatsReport())}catch(t){i(t)}}))},e.getSrtpCipher=async function(t){return new Promise((async(e,i)=>{t[0].rtcStatsReport.forEach((t=>{"transport"===t.type&&(console.log(t.srtpCipher),e(t.srtpCipher))}))}))}}},e={};function i(s){var r=e[s];if(void 0!==r)return r.exports;var n=e[s]={exports:{}};return t[s].call(n.exports,n,n.exports,i),n.exports}var s={};return(()=>{"use strict";var t=s;Object.defineProperty(t,"__esModule",{value:!0}),t.getRtcStats=t.logPublisher=void 0;const e=i(43),r=i(436);Object.defineProperty(t,"logPublisher",{enumerable:!0,get:function(){return r.logPublisher}}),Object.defineProperty(t,"getRtcStats",{enumerable:!0,get:function(){return r.getRtcStats}});const n=i(239);window.OT=window.OT||{},e.default.setLevel("WARN"),window.OT.RealTimeStats={logPublisher:r.logPublisher,getRtcStats:r.getRtcStats,VideoNetworkQualityStats:n.VideoNetworkQualityStats}})(),s})()));
//# sourceMappingURL=vonage-real-time-stats.js.map