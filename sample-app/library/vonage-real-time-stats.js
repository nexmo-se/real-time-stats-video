!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealTimeStats=e():t.RealTimeStats=e()}(self,(()=>(()=>{var t={187:t=>{"use strict";var e,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};e=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var r=Number.isNaN||function(t){return t!=t};function o(){o.init.call(this)}t.exports=o,t.exports.once=function(t,e){return new Promise((function(n,i){function r(n){t.removeListener(e,o),i(n)}function o(){"function"==typeof t.removeListener&&t.removeListener("error",r),n([].slice.call(arguments))}y(t,e,o,{once:!0}),"error"!==e&&function(t,e,n){"function"==typeof t.on&&y(t,"error",e,n)}(t,r,{once:!0})}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var s=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?o.defaultMaxListeners:t._maxListeners}function l(t,e,n,i){var r,o,s,l;if(a(n),void 0===(o=t._events)?(o=t._events=Object.create(null),t._eventsCount=0):(void 0!==o.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),o=t._events),s=o[e]),void 0===s)s=o[e]=n,++t._eventsCount;else if("function"==typeof s?s=o[e]=i?[n,s]:[s,n]:i?s.unshift(n):s.push(n),(r=c(t))>0&&s.length>r&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=s.length,l=u,console&&console.warn&&console.warn(l)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(t,e,n){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},r=u.bind(i);return r.listener=n,i.wrapFn=r,r}function f(t,e,n){var i=t._events;if(void 0===i)return[];var r=i[e];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(r):v(r,r.length)}function h(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function v(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}function y(t,e,n,i){if("function"==typeof t.on)i.once?t.once(e,n):t.on(e,n);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function r(o){i.once&&t.removeEventListener(e,r),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");s=t}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},o.prototype.getMaxListeners=function(){return c(this)},o.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var r="error"===t,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var s;if(e.length>0&&(s=e[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=o[t];if(void 0===c)return!1;if("function"==typeof c)i(c,this,e);else{var l=c.length,u=v(c,l);for(n=0;n<l;++n)i(u[n],this,e)}return!0},o.prototype.addListener=function(t,e){return l(this,t,e,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(t,e){return l(this,t,e,!0)},o.prototype.once=function(t,e){return a(e),this.on(t,p(this,t,e)),this},o.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,p(this,t,e)),this},o.prototype.removeListener=function(t,e){var n,i,r,o,s;if(a(e),void 0===(i=this._events))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===e||n[o].listener===e){s=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,r),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,s||e)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(t){var e,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var r,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;i>=0;i--)this.removeListener(t,e[i]);return this},o.prototype.listeners=function(t){return f(this,t,!0)},o.prototype.rawListeners=function(t){return f(this,t,!1)},o.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):h.call(t,e)},o.prototype.listenerCount=h,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}},43:function(t,e,n){var i,r;!function(o,s){"use strict";i=function(){var t=function(){},e="undefined",n=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"];function r(t,e){var n=t[e];if("function"==typeof n.bind)return n.bind(t);try{return Function.prototype.bind.call(n,t)}catch(e){return function(){return Function.prototype.apply.apply(n,[t,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(i){return"debug"===i&&(i="log"),typeof console!==e&&("trace"===i&&n?o:void 0!==console[i]?r(console,i):void 0!==console.log?r(console,"log"):t)}function a(e,n){for(var r=0;r<i.length;r++){var o=i[r];this[o]=r<e?t:this.methodFactory(o,e,n)}this.log=this.debug}function c(t,n,i){return function(){typeof console!==e&&(a.call(this,n,i),this[t].apply(this,arguments))}}function l(t,e,n){return s(t)||c.apply(this,arguments)}function u(t,n,r){var o,s=this;n=null==n?"WARN":n;var c="loglevel";function u(t){var n=(i[t]||"silent").toUpperCase();if(typeof window!==e&&c){try{return void(window.localStorage[c]=n)}catch(t){}try{window.document.cookie=encodeURIComponent(c)+"="+n+";"}catch(t){}}}function p(){var t;if(typeof window!==e&&c){try{t=window.localStorage[c]}catch(t){}if(typeof t===e)try{var n=window.document.cookie,i=n.indexOf(encodeURIComponent(c)+"=");-1!==i&&(t=/^([^;]+)/.exec(n.slice(i))[1])}catch(t){}return void 0===s.levels[t]&&(t=void 0),t}}function f(){if(typeof window!==e&&c){try{return void window.localStorage.removeItem(c)}catch(t){}try{window.document.cookie=encodeURIComponent(c)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(t){}}}"string"==typeof t?c+=":"+t:"symbol"==typeof t&&(c=void 0),s.name=t,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=r||l,s.getLevel=function(){return o},s.setLevel=function(n,i){if("string"==typeof n&&void 0!==s.levels[n.toUpperCase()]&&(n=s.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=s.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(o=n,!1!==i&&u(n),a.call(s,n,t),typeof console===e&&n<s.levels.SILENT)return"No console available for logging"},s.setDefaultLevel=function(t){n=t,p()||s.setLevel(t,!1)},s.resetLevel=function(){s.setLevel(n,!1),f()},s.enableAll=function(t){s.setLevel(s.levels.TRACE,t)},s.disableAll=function(t){s.setLevel(s.levels.SILENT,t)};var h=p();null==h&&(h=n),s.setLevel(h,!1)}var p=new u,f={};p.getLogger=function(t){if("symbol"!=typeof t&&"string"!=typeof t||""===t)throw new TypeError("You must supply a name when creating a logger.");var e=f[t];return e||(e=f[t]=new u(t,p.getLevel(),p.methodFactory)),e};var h=typeof window!==e?window.log:void 0;return p.noConflict=function(){return typeof window!==e&&window.log===p&&(window.log=h),p},p.getLoggers=function(){return f},p.default=p,p},void 0===(r="function"==typeof i?i.call(e,n,e,t):i)||(t.exports=r)}()},239:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.VideoNetworkQualityStats=void 0;const i=n(43),r=n(436),o=n(187);var s;!function(t){t[t.PAUSED=0]="PAUSED",t[t.EFFECT_APPLIED=1]="EFFECT_APPLIED",t[t.INPUT_FORWARDING=2]="INPUT_FORWARDING"}(s||(s={}));class a extends o.EventEmitter{constructor(t){super(),this.prevPacketsLost={},this.prevTimeStamp={},this.simulcastLayers=[],this.prevPacketsSent={},this._publisher=null,this._statsInterval=t.intervalStats,this._interval=null,this.isQualityLimitated=!1,this.wasQualityLimited=!1,this.prevPacketsSent={},this.prevPacketsLost={},this.packetLossArray=[],this.layersWithPacketLoss=[]}setPublisher(t){this._publisher=t}checkIfQualityLimited(t){t[0].rtcStatsReport.forEach((t=>{if("outbound-rtp"===t.type&&"video"===t.kind){if(this.prevTimeStamp[t.ssrc]&&this.prevPacketsSent[t.ssrc]){const e=t.timestamp-this.prevTimeStamp[t.ssrc],n=8*(t.bytesSent-this.prevPacketsSent[t.ssrc])/e,i={width:t.frameWidth,height:t.frameHeight,framesPerSecond:t.framesPerSecond,qualityLimitationReason:t.qualityLimitationReason,id:t.ssrc,bytes:n,packetsDiff:t.packetsSent-this.prevPacketsSent[t.ssrc]};this.simulcastLayers=[...this.simulcastLayers,i],this.simulcastLayers.forEach((t=>{"none"===t.qualityLimitationReason||!1!==this.isQualityLimitated||this.wasQualityLimited?this.wasQualityLimited&&"none"===t.qualityLimitationReason&&this.isQualityLimitated&&(this.isQualityLimitated=!1,this.emit("qualityLimitatedStopped",{streamId:this._publisher.stream.id,reason:t.qualityLimitationReason,targetQuality:`${t.width}X${t.height}`})):(this.isQualityLimitated=!0,this.emit("qualityLimitated",{streamId:this._publisher.stream.id,reason:t.qualityLimitationReason,targetQuality:`${t.width}X${t.height}`}))}))}this.prevPacketsSent[t.ssrc]=t.packetsSent,this.prevTimeStamp[t.ssrc]=t.timestamp,this.wasQualityLimited=this.isQualityLimitated}}))}checkVideoPacketLoss(t){t[0].rtcStatsReport.forEach((t=>{if("remote-inbound-rtp"===t.type&&"video"===t.kind){const e={ssrc:t.ssrc,rtt:t.roundTripTime,jitter:t.jitter,packetLostFraction:100*t.fractionLost,packetsLostDiff:t.packetsLost-this.prevPacketsLost[t.ssrc]};this.packetLossArray=[...this.packetLossArray,e],this.prevPacketsLost[t.ssrc]=t.packetsLost,this.mergeArrays()}}))}mergeArrays(){if(this.packetLossArray&&this.simulcastLayers.length){this.layersWithPacketLoss=[];for(let t of this.simulcastLayers)for(let e of this.packetLossArray)if(t.id===e.ssrc&&t.framesPerSecond){const n=t.packetsDiff+e.packetsLostDiff,i=e.packetsLostDiff/n,r=Object.assign({rtt:e.rtt,jitter:e.jitter,packetLost:100*i},t);this.layersWithPacketLoss=[...this.layersWithPacketLoss,r];const o=Math.max.apply(Math,this.layersWithPacketLoss.map((function(t){return t.id}))),s=this.layersWithPacketLoss.find((function(t){return t.id==o}));s.packetLost>3&&console.log(s.packetLost)}}}startStats(){setInterval((async()=>{this.simulcastLayers=[],this.packetLossArray=[];const t=await(0,r.getRtcStats)(this._publisher);return this.checkIfQualityLimited(t),this.checkVideoPacketLoss(t),t}),this._statsInterval)}stopStats(){clearInterval(this._interval),this._interval=null}async getCypher(){return new Promise((async(t,e)=>{(await(0,r.getRtcStats)(this._publisher))[0].rtcStatsReport.forEach((e=>{"transport"===e.type&&(console.log(e.srtpCipher),t(e.srtpCipher))}))}))}async getConnectionType(){return new Promise((async(t,e)=>{(await(0,r.getRtcStats)(this._publisher))[0].rtcStatsReport.forEach((e=>{"local-candidate"===e.type&&("relay"===e.candidateType?t(`TURN ${e.relayProtocol}`):t(e.protocol))}))}))}pauseStreamProcessing(t){console.log("ss")}setOutputState(t){}destroy(){i.default.debug("destroy")}}e.VideoNetworkQualityStats=a},436:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getSrtpCipher=e.getRtcStats=e.logPublisher=void 0,e.logPublisher=function(t){console.log(t)},e.getRtcStats=async function(t){return new Promise((async(e,n)=>{try{e(await t.getRtcStatsReport())}catch(t){n(t)}}))},e.getSrtpCipher=async function(t){return new Promise((async(e,n)=>{t[0].rtcStatsReport.forEach((t=>{"transport"===t.type&&(console.log(t.srtpCipher),e(t.srtpCipher))}))}))}}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,n),o.exports}var i={};return(()=>{"use strict";var t=i;Object.defineProperty(t,"__esModule",{value:!0}),t.getRtcStats=t.logPublisher=void 0;const e=n(43),r=n(436);Object.defineProperty(t,"logPublisher",{enumerable:!0,get:function(){return r.logPublisher}}),Object.defineProperty(t,"getRtcStats",{enumerable:!0,get:function(){return r.getRtcStats}});const o=n(239);window.OT=window.OT||{},e.default.setLevel("WARN"),window.OT.RealTimeStats={logPublisher:r.logPublisher,getRtcStats:r.getRtcStats,VideoNetworkQualityStats:o.VideoNetworkQualityStats}})(),i})()));
//# sourceMappingURL=vonage-real-time-stats.js.map