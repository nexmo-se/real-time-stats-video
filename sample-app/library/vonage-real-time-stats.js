!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RealTimeStats=e():t.RealTimeStats=e()}(self,(()=>(()=>{"use strict";var t={187:t=>{var e,s="object"==typeof Reflect?Reflect:null,i=s&&"function"==typeof s.apply?s.apply:function(t,e,s){return Function.prototype.apply.call(t,e,s)};e=s&&"function"==typeof s.ownKeys?s.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var r=Number.isNaN||function(t){return t!=t};function n(){n.init.call(this)}t.exports=n,t.exports.once=function(t,e){return new Promise((function(s,i){function r(s){t.removeListener(e,n),i(s)}function n(){"function"==typeof t.removeListener&&t.removeListener("error",r),s([].slice.call(arguments))}v(t,e,n,{once:!0}),"error"!==e&&function(t,e,s){"function"==typeof t.on&&v(t,"error",e,s)}(t,r,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var o=10;function a(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function c(t){return void 0===t._maxListeners?n.defaultMaxListeners:t._maxListeners}function h(t,e,s,i){var r,n,o,h;if(a(s),void 0===(n=t._events)?(n=t._events=Object.create(null),t._eventsCount=0):(void 0!==n.newListener&&(t.emit("newListener",e,s.listener?s.listener:s),n=t._events),o=n[e]),void 0===o)o=n[e]=s,++t._eventsCount;else if("function"==typeof o?o=n[e]=i?[s,o]:[o,s]:i?o.unshift(s):o.push(s),(r=c(t))>0&&o.length>r&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=o.length,h=u,console&&console.warn&&console.warn(h)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(t,e,s){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:s},r=u.bind(i);return r.listener=s,i.wrapFn=r,r}function p(t,e,s){var i=t._events;if(void 0===i)return[];var r=i[e];return void 0===r?[]:"function"==typeof r?s?[r.listener||r]:[r]:s?function(t){for(var e=new Array(t.length),s=0;s<e.length;++s)e[s]=t[s].listener||t[s];return e}(r):d(r,r.length)}function f(t){var e=this._events;if(void 0!==e){var s=e[t];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function d(t,e){for(var s=new Array(e),i=0;i<e;++i)s[i]=t[i];return s}function v(t,e,s,i){if("function"==typeof t.on)i.once?t.once(e,s):t.on(e,s);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function r(n){i.once&&t.removeEventListener(e,r),s(n)}))}}Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");o=t}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},n.prototype.getMaxListeners=function(){return c(this)},n.prototype.emit=function(t){for(var e=[],s=1;s<arguments.length;s++)e.push(arguments[s]);var r="error"===t,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var o;if(e.length>0&&(o=e[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=n[t];if(void 0===c)return!1;if("function"==typeof c)i(c,this,e);else{var h=c.length,u=d(c,h);for(s=0;s<h;++s)i(u[s],this,e)}return!0},n.prototype.addListener=function(t,e){return h(this,t,e,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(t,e){return h(this,t,e,!0)},n.prototype.once=function(t,e){return a(e),this.on(t,l(this,t,e)),this},n.prototype.prependOnceListener=function(t,e){return a(e),this.prependListener(t,l(this,t,e)),this},n.prototype.removeListener=function(t,e){var s,i,r,n,o;if(a(e),void 0===(i=this._events))return this;if(void 0===(s=i[t]))return this;if(s===e||s.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,s.listener||e));else if("function"!=typeof s){for(r=-1,n=s.length-1;n>=0;n--)if(s[n]===e||s[n].listener===e){o=s[n].listener,r=n;break}if(r<0)return this;0===r?s.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(s,r),1===s.length&&(i[t]=s[0]),void 0!==i.removeListener&&this.emit("removeListener",t,o||e)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(t){var e,s,i;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[t]),this;if(0===arguments.length){var r,n=Object.keys(s);for(i=0;i<n.length;++i)"removeListener"!==(r=n[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=s[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;i>=0;i--)this.removeListener(t,e[i]);return this},n.prototype.listeners=function(t){return p(this,t,!0)},n.prototype.rawListeners=function(t){return p(this,t,!1)},n.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},n.prototype.listenerCount=f,n.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}},239:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.VideoNetworkQualityStats=void 0;const i=s(436),r=s(187);class n extends r.EventEmitter{constructor(t){super(),this.prevTimeStamp={},this.simulcastLayers=[],this.prevPacketsSent={},this._publisher,this._statsInterval=t.intervalStats||5e3,this._VideoPacketLossThreshold=t.VideoPacketLossThreshold||5,this._interval=null,this.isQualityLimited=!1,this.wasQualityLimited=!1,this.hasPacketLoss=!1,this.hadPacketLoss=!1,this.prevPacketsSent={},this.prevPacketsLost={},this.packetLossArray=[],this.layersWithPacketLoss=[]}setPublisher(t){this._publisher=t}getSimulcastLayers(){return this.simulcastLayers.length?this.simulcastLayers:[]}checkIfQualityLimited(t){t[0].rtcStatsReport.forEach((t=>{if("outbound-rtp"===t.type&&"video"===t.kind){if(this.prevTimeStamp[t.ssrc]&&this.prevPacketsSent[t.ssrc]){const e=t.timestamp-this.prevTimeStamp[t.ssrc],s=8*(t.bytesSent-this.prevPacketsSent[t.ssrc])/e;if(t.framesPerSecond){const e={width:t.frameWidth,height:t.frameHeight,framesPerSecond:t.framesPerSecond,qualityLimitationReason:t.qualityLimitationReason,id:t.ssrc,bytes:s,packetsDiff:t.packetsSent-this.prevPacketsSent[t.ssrc]};this.simulcastLayers=[...this.simulcastLayers,e],this.simulcastLayers.forEach((t=>{var e,s,i,r;"none"===t.qualityLimitationReason||!1!==this.isQualityLimited||this.wasQualityLimited?this.wasQualityLimited&&"none"===t.qualityLimitationReason&&this.isQualityLimited&&(this.isQualityLimited=!1,this.emit("qualityLimitedStopped",{streamId:null===(r=null===(i=this._publisher)||void 0===i?void 0:i.stream)||void 0===r?void 0:r.id,reason:t.qualityLimitationReason})):(this.isQualityLimited=!0,this.emit("qualityLimited",{streamId:null===(s=null===(e=this._publisher)||void 0===e?void 0:e.stream)||void 0===s?void 0:s.id,reason:t.qualityLimitationReason,id:t.id,currentResolution:`${t.width}X${t.height}`}))}))}}this.prevPacketsSent[t.ssrc]=t.packetsSent,this.prevTimeStamp[t.ssrc]=t.timestamp,this.wasQualityLimited=this.isQualityLimited}}))}checkVideoPacketLoss(t){t[0].rtcStatsReport.forEach((t=>{if("remote-inbound-rtp"===t.type&&"video"===t.kind){const e={ssrc:t.ssrc,rtt:t.roundTripTime,jitter:t.jitter,packetLostFraction:100*t.fractionLost,packetsLostDiff:t.packetsLost-this.prevPacketsLost[t.ssrc]};this.packetLossArray=[...this.packetLossArray,e],this.prevPacketsLost[t.ssrc]=t.packetsLost,this.mergeArrays()}}))}mergeArrays(){var t,e,s,i;if(this.packetLossArray&&this.simulcastLayers.length){this.layersWithPacketLoss=[];for(let r of this.simulcastLayers)for(let n of this.packetLossArray)if(r.id===n.ssrc&&r.framesPerSecond){const o=r.packetsDiff+n.packetsLostDiff,a=n.packetsLostDiff/o,c=Object.assign({rtt:n.rtt,jitter:n.jitter,packetLost:100*a},r);this.layersWithPacketLoss=[...this.layersWithPacketLoss,c];const h=Math.max.apply(Math,this.layersWithPacketLoss.map((function(t){return t.id}))),u=this.layersWithPacketLoss.find((function(t){return t.id==h}));u.packetLost>=this._VideoPacketLossThreshold&&!this.hadPacketLoss&&!this.hasPacketLoss?(this.hasPacketLoss=!0,this.emit("highPacketLoss",{streamId:null===(e=null===(t=this._publisher)||void 0===t?void 0:t.stream)||void 0===e?void 0:e.id,type:"video",action:"highPacketLossDetected",packetLossThreshold:this._VideoPacketLossThreshold})):this.hadPacketLoss&&this.hasPacketLoss&&u.packetLost<this._VideoPacketLossThreshold&&(this.hasPacketLoss=!1,this.emit("highPacketLossStopped",{streamId:null===(i=null===(s=this._publisher)||void 0===s?void 0:s.stream)||void 0===i?void 0:i.id,type:"video",action:"highPacketLossStopped",packetLossThreshold:this._VideoPacketLossThreshold}))}this.hadPacketLoss=this.hasPacketLoss}}async startStats(){return new Promise(((t,e)=>{setInterval((async()=>{this.simulcastLayers=[],this.packetLossArray=[];try{"function"==typeof this._publisher.getRtcStatsReport&&this._publisher||e("Invalid publisher");const s=await(0,i.getRtcStats)(this._publisher);s&&s.length?(/chrome/i.test(navigator.userAgent)&&this.checkIfQualityLimited(s),this.checkVideoPacketLoss(s),t()):e("can not start rtcStats")}catch(t){e(t)}}),this._statsInterval)}))}stopStats(){clearInterval(this._interval),this._interval=null}async getCipher(){return new Promise((async(t,e)=>{try{const s=await(0,i.getRtcStats)(this._publisher);s||e("Can not get cypher"),s[0].rtcStatsReport.forEach((e=>{"transport"===e.type&&t(e.srtpCipher)}))}catch(t){e(t)}}))}async getConnectionType(){return new Promise((async(t,e)=>{try{const s=await(0,i.getRtcStats)(this._publisher);s||e("Can not get connection type"),s[0].rtcStatsReport.forEach((e=>{"local-candidate"===e.type&&("relay"===e.candidateType?t(`TURN ${e.relayProtocol}`):t(e.protocol))}))}catch(t){e(t)}}))}}e.VideoNetworkQualityStats=n},436:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.getRtcStats=void 0,e.getRtcStats=async function(t){return new Promise((async(e,s)=>{try{"function"!=typeof t.getRtcStatsReport&&s("Invalid publisher");e(await t.getRtcStatsReport())}catch(t){s(t)}}))}}},e={};function s(i){var r=e[i];if(void 0!==r)return r.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,s),n.exports}var i={};return(()=>{var t=i;Object.defineProperty(t,"__esModule",{value:!0}),t.VideoNetworkQualityStats=void 0;const e=s(239);Object.defineProperty(t,"VideoNetworkQualityStats",{enumerable:!0,get:function(){return e.VideoNetworkQualityStats}}),window.OT=window.OT||{},window.OT.RealTimeStats={VideoNetworkQualityStats:e.VideoNetworkQualityStats}})(),i})()));
//# sourceMappingURL=vonage-real-time-stats.js.map